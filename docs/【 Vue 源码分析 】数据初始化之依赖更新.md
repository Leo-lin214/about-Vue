## å…ˆèŠèŠè§‚å¯Ÿè€…æ¨¡å¼

è§‚å¯Ÿè€…æ¨¡å¼ï¼Œåˆå«è®¢é˜…-å‘å¸ƒæ¨¡å¼ï¼Œå®šä¹‰äº†ä¸€ç§ä¸€å¯¹å¤šçš„å…³ç³»ã€‚è®©å¤šä¸ªå¯¹è±¡åŒæ—¶è§‚å¯ŸæŸä¸€ä¸ªä¸»é¢˜å¯¹è±¡çš„å˜åŒ–ï¼Œä»è€Œæ‰§è¡Œç›¸å¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚ç°åœ¨å°±æ¥çœ‹ä¸€ä¸‹è§‚å¯Ÿè€…æ¨¡å¼çš„å®ç°æ€æƒ³ï¼š

- å‘å¸ƒè€…ï¼ˆæŸä¸€ä¸»é¢˜å¯¹è±¡ï¼‰éœ€åŒ…å«ä¸€ä¸ªæ•°ç»„å±æ€§ç”¨äºå­˜å‚¨è®¢é˜…è€…å¯¹è±¡ï¼›
- è®¢é˜…æ—¶ï¼šç›´æ¥å°†è®¢é˜…è€…`Push`åˆ°å‘å¸ƒè€…æ•°ç»„å±æ€§ä¸­ï¼›
- é€€è®¢æ—¶ï¼šé€šè¿‡å¾ªç¯éå†ï¼Œå°†éœ€è¦é€€è®¢çš„è®¢é˜…è€…ä»å‘å¸ƒè€…çš„æ•°ç»„å±æ€§ä¸­åˆ é™¤ï¼›
- å‘å¸ƒæ—¶ï¼šé€šè¿‡å¾ªç¯éå†ï¼Œé€ä¸€æ‰§è¡Œå‘å¸ƒè€…æ•°ç»„å±æ€§ä¸­æ¯ä¸ªå…ƒç´ çš„å›è°ƒå‡½æ•°ï¼›

è¯¥æ¨¡å¼æ€æƒ³å¤§æ¦‚äº†è§£äº†ï¼Œé‚£ç”¨ JavaScript ç©¶ç«Ÿå¦‚ä½•å®ç°å‘¢ï¼Ÿç°åœ¨å°±æ¥ç…ç…ï¼š

```javascript
// å‘å¸ƒè€…
function Publisher() {
  this.watcher = []
}
Publisher.prototype.addWatcher = obj => {
  this.watcher.push(obj)
}
Publisher.prototype.publish = obj => {
  this.watcher.forEach(item => { typeof item.update === 'function' && item.update() })
}

// è®¢é˜…è€…
function Subscriber(name) {
  this.name = name
}
Subscriber.prototype.update = function() {
  console.log(`${this.name} is updated.........`)
}
```

æ—¢ç„¶æåˆ°è§‚å¯Ÿè€…æ¨¡å¼ï¼Œé‚£è‚¯å®šå’Œæœ¬ä¸»é¢˜ç›¸å…³è”ã€‚é¦–å…ˆåœ¨ Vue å®ç°çš„ä¾èµ–æ”¶é›†ä»¥åŠä¾èµ–æ›´æ–°ä¸­ï¼Œå…¶å®å°±æ˜¯ç”¨åˆ°äº†è§‚å¯Ÿè€…æ¨¡å¼ï¼Œå“åº”å¼å±æ€§å°±æ˜¯å‘å¸ƒè€…ï¼Œè€Œ Watcher ä¾èµ–å°±æ˜¯è®¢é˜…è€…ã€‚æ¯å½“å“åº”å¼å±æ€§å‘ç”Ÿæ›´æ–°æ—¶ï¼Œéƒ½ä¼šç›´æ¥é€šçŸ¥åˆ°å…¶ dep ä¸­ä¿å­˜çš„æ‰€æœ‰è®¢é˜…è€…è¿›è¡Œå“åº”çš„æ›´æ–°ã€‚

æ¥ä¸‹æ¥ï¼Œå°±è®©æˆ‘ä»¬ç…ç…åœ¨ Vue ä¸­æ˜¯å¦‚ä½•å®ç°ä¾èµ–æ›´æ–°çš„ã€‚



## ä»æºç è§’åº¦åˆ†æ

ä»å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘æœ‰æåŠè¿‡ï¼Œæ¶‰åŠåˆ°å“åº”å¼å±æ€§çš„ä¾èµ–æ›´æ–°ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªåœ°æ–¹ï¼Œåˆ†åˆ«æ˜¯ Setter å‡½æ•°å’Œå…¨å±€`$set`æ–¹æ³•ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±åˆ†åˆ«æ¥çœ‹çœ‹ ğŸ¤” ã€‚

1. Setter å‡½æ•°ä¸­ä¾èµ–æ›´æ–°

   å‰é¢æåˆ°ï¼Œåªæœ‰ Vue èƒ½ç›‘æµ‹åˆ°çš„æ›´æ–°æ‰ä¼šä¸»åŠ¨è§¦å‘ Setter å‡½æ•°ï¼Œå…ˆçœ‹ä¸‹æºç ä¸­çš„ Setter å‡½æ•°æ˜¯å¦‚ä½•å¤„ç†çš„ï¼š

   ```javascript
   function defineReactive$$1 (
   	obj,
    	key,
    	val,
    	customSetter,
    	shallow
   ) {
       // ...
       Object.defineProperty(obj, key, {
         enumerable: true,
         configurable: true,
         // ...
         set: function reactiveSetter (newVal) {
           // ...
           dep.notify();
         }
       })
     }
   
   Dep.prototype.notify = function notify () {
     var subs = this.subs.slice(); // æ•°ç»„çš„æµ…å¤åˆ¶ï¼Œé¿å…å½±å“åˆ°å…ƒç´ ç»„
     // ...
     for (var i = 0, l = subs.length; i < l; i++) {
       subs[i].update();
     }
   }
   ```

   ä¸Šè¿°ä»£ç å¾ˆå¥½ç†è§£ï¼Œå½“å“åº”å¼å±æ€§æ›´æ–°æ—¶ï¼Œä¼šç›´æ¥è§¦å‘åˆ° Setter å‡½æ•°ï¼Œè¿™æ—¶å€™å°±ä¼šè°ƒç”¨ dep å¯¹è±¡ä¸Šçš„ notify æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åšçš„äº‹æƒ…å°±æ˜¯éå†å…¶ä¿å­˜çš„ Watcher ä¾èµ–ï¼Œå¹¶é€ä¸ªè§¦å‘å…¶æ›´æ–°å›è°ƒå‡½æ•°ã€‚

   çœ‹åˆ°è¿™é‡Œï¼Œä¹Ÿè®¸ä½ è¿˜ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼Œé‚£å°±æ˜¯ Watcher ä¾èµ–çš„æ›´æ–°å›è°ƒå‡½æ•°æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿ

   å…¶å®åœ¨å…ƒç´ æŒ‚è½½æ—¶æ‰€åˆ›å»ºçš„ Watcher ä¾èµ–å°±å·²ç»å®šä¹‰äº†å…¶æ›´æ–°å›è°ƒå‡½æ•°ï¼Œç°åœ¨å°±æ¥çœ‹çœ‹

   ```javascript
   function mountComponent (
   	vm,
    	el,
    	hydrating
   ) {
       // ...
       var updateComponent;
       updateComponent = function () { // æ›´æ–°å›è°ƒå‡½æ•°çš„è®¾ç½®
         vm._update(vm._render(), hydrating);
       };
       new Watcher(vm, updateComponent, noop, {
         before: function before () {
           if (vm._isMounted && !vm._isDestroyed) {
             callHook(vm, 'beforeUpdate');
           }
         }
       }, true /* isRenderWatcher */);
       // ...
     }
   
   var Watcher = function Watcher (
   	vm,
    	expOrFn,
    	cb,
    	options,
    	isRenderWatcher
   ) {
       // ...
       if (typeof expOrFn === 'function') { // expOrFn å°±æ˜¯æ›´æ–°å›è°ƒå‡½æ•°
         this.getter = expOrFn;
       }
       // ...
     }
   
   Watcher.prototype.update = function update () {
     /* istanbul ignore else */
   	// ...
     queueWatcher(this); // åˆ©ç”¨é˜Ÿåˆ—å½¢å¼è¿›è¡Œæ›´æ–°æ¯ä¸€ä¸ª Watcher ä¾èµ–ï¼Œè¯¥æ–¹æ³•ä¸­æœ€åéƒ½ä¼šç›´æ¥æ‰§è¡Œå…¶æ›´æ–°å›è°ƒå‡½æ•°
   };
   
   ```

   å¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼Œç»„ä»¶åœ¨æŒ‚è½½çš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ Watcher ä¾èµ–æœ¬èº«çš„ getter å±æ€§è¿›è¡Œæ”¶é›†æ›´æ–°å›è°ƒå‡½æ•°ã€‚å¦å¤–ï¼Œå½“æ‰§è¡Œ Watcher ä¾èµ–çš„ update æ–¹æ³•æ—¶ï¼Œå³ç›¸å½“äºæ‰§è¡Œäº† queueWatcher æ–¹æ³•ã€‚

    queueWatcher æ–¹æ³•éœ€è¦æ¢è®¨ä¸€ä¸‹çš„æ˜¯ï¼Œä¼šå°† Watcher ä¾èµ–æ¨è¿›åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åå†æŒ‰é¡ºåºæ»´æ‹¿å‡ºæ¥è¿›è¡Œæ›´æ–°ï¼Œè€Œæ‰€è°“çš„æ›´æ–°å°±æ˜¯ç›´æ¥è°ƒç”¨äº†å…¶ Watcher ä¾èµ–æœ¬èº«çš„ getter å‡½æ•°ï¼Œä»è€Œæ›´æ–°ä¾èµ–ä¸­å“åº”å¼å±æ€§çš„å€¼ã€‚

   

2. å…¨å±€`$set`æ–¹æ³•ä¸­ä¾èµ–æ›´æ–°

   åœ¨ä¾èµ–æ”¶é›†çš„ç« èŠ‚ä¸­ï¼Œæˆ‘æœ‰è¯´è¿‡ï¼Œå®˜æ–¹æä¾›çš„å…¨å±€`$set`æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨`__ob__`ä¸­ä¿å­˜çš„ä¾èµ–è¿›è¡Œè®¾ç½®å’Œæ›´æ–°çš„ã€‚ç°åœ¨æˆ‘ä»¬å°±æ¥çœ‹çœ‹æºç ç©¶ç«Ÿæ˜¯å¦‚ä½•è®¾ç½®å’Œæ›´æ–°çš„ï¼š

   ```javascript
   Vue.prototype.$set = set;
   
   /**
    * Set a property on an object. Adds the new property and
    * triggers change notification if the property doesn't
    * already exist.
    */
   function set (target, key, val) {
     // ...
     var ob = (target).__ob__;
     // ...
     defineReactive$$1(ob.value, key, val); // å¯¹æ–°æ·»åŠ å±æ€§è¿›è¡Œå“åº”å¼å¤„ç†
     ob.dep.notify(); // åˆå§‹åŒ–å“åº”å¼å¤„ç†åï¼ŒåŒæ—¶é€šçŸ¥æ›´æ–°
   }
   ```

   ç”±ä»£ç ä¸­ set æ–¹æ³•æ³¨é‡Šå¯ä»¥çœ‹åˆ°ï¼Œåœ¨å“åº”å¼å¯¹è±¡ä¸Šæ–°å¢å±æ€§æ—¶è§¦å‘æ›´æ–°é€šçŸ¥ã€‚åœ¨è§¦å‘æ›´æ–°å‰ï¼Œä¼šå…ˆæŠŠæ–°å¢çš„å±æ€§è¿›è¡Œå“åº”å¼å¤„ç† defineReactive$$1 ï¼Œç´§æ¥ç€å°±æ˜¯æ ¹æ®æ­¤å‰å­˜å‚¨çš„`__ob__`ä¸­ä¾èµ–è¿›è¡Œé€ä¸€é€šçŸ¥æ›´æ–°ï¼Œå…¶ä¸­æ›´æ–°è¿‡ç¨‹å’Œä¸Šè¿°è°ƒç”¨ Watcher ä¾èµ–çš„ update æ–¹æ³•æ˜¯ä¸€æ ·çš„ã€‚



ç°åœ¨æ¥æ€»ç»“ä¸€ä¸‹ï¼š

- Vue ä¸­å®ç°ä¾èµ–æ›´æ–°æ˜¯ä½¿ç”¨äº†è§‚å¯Ÿè€…æ¨¡å¼ï¼Œé€šè¿‡ Getter å‡½æ•°å’Œ`__ob__`ä¸­æ”¶é›†çš„ä¾èµ–è¿›è¡Œé€ä¸€æ›´æ–°ï¼›
- å¯¹å“åº”å¼å±æ€§çš„å¤„ç†ä¼šä¸»åŠ¨è§¦å‘ Setter å‡½æ•°ï¼Œç„¶åä½¿ç”¨ Getter å‡½æ•°ä¸­æ”¶é›†çš„ä¾èµ–è¿›è¡Œé€ä¸€æ›´æ–°ã€‚å¯¹éå“åº”å¼å±æ€§çš„å¤„ç†ï¼Œåˆ™éœ€è¦è°ƒç”¨å…¨å±€ $set æ–¹æ³•ï¼Œä½¿ç”¨`__ob__`ä¸­æ”¶é›†çš„ä¾èµ–è¿›è¡Œé€ä¸€æ›´æ–°å¹¶ä¸”æŠŠè¯¥**æ–°å¢å±æ€§è¿›è¡Œå“åº”å¼å¤„ç†**ï¼›
- æ›´æ–°å›è°ƒå‡½æ•°ä¼šåœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰€åˆ›å»ºçš„ Watcher ä¾èµ–è¿›è¡Œè®¾ç½®ï¼Œåœ¨é€šçŸ¥æ›´æ–°æ—¶ï¼Œä¼šç›´æ¥ä½¿ç”¨é˜Ÿåˆ—çš„æ–¹å¼è¿›è¡Œæ›´æ–°ï¼Œå…ˆåˆ°å…ˆå¤„ç†ï¼›























